<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
    <meta name="generator" content="Hugo 0.88.1">
    <title>Visualization Project Â· Github</title>

    <!-- Bootstrap core CSS -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">

    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
      body{
        background-color: #eee;
      }
      .input-box {
        position: relative
    }

    .input-box i {
        position: absolute;
        right: 12px;
        top: 8px;
        color: #ced4da
    }
    .page-title {
        font-size: 18px;
        margin: 0;
        line-height: 75px;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        color: inherit;
    }
    </style>

    <link href="/static/css/bootstrap-icons.css" rel="stylesheet">

  </head>
  <body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark" aria-label="Tenth navbar example">
    <div class="container">
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample08" aria-controls="navbarsExample08" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarsExample08">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="#">GitHub Visualization Project</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

    <div class="container mt-5">
        <div class="row">
            <div class="col-sm-5 col-md-4 col-lg-4">
                <div class="card shadow border-1 p-2">
                    <form class="input-box mt-2">
                        <input type="text" name="name" class="form-control bg-light"> <i class="bi bi-search"></i>
                    </form>
                    <div class="mt-2" id="messageContainer"></div>
                    <div class="mt-2" id="dataContainer">
                        <div class="list-group" id="userListContainer">
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-7 col-md-8 col-lg-8" id="detailContainer">

                <div class="row">
                <div class="col-md-12 col-sm-12 pb-3">
                    <span class="fs-5" id="usernameContainer">UserName</span>
                </div>
                <div class="col mb-3">
                    <div class="card border-light shadow">
                        <div class="card-body">
                            <h5 class="text-muted fw-normal mt-0" >Repos</h5>
                            <h3 class="mt-3 mb-3 text-center" id="reposCountContainer">---</h3>
                        </div> <!-- end card-body-->
                    </div> <!-- end card-->
                </div> <!-- end col-->
                <div class="col mb-3">
                    <div class="card border-light shadow">
                        <div class="card-body">
                            <h5 class="text-muted fw-normal mt-0">Followers</h5>
                            <h3 class="mt-3 mb-3 text-center"  id="followersCountContainer">---</h3>
                        </div> <!-- end card-body-->
                    </div> <!-- end card-->
                </div> <!-- end col-->
                <div class="col mb-3">
                    <div class="card border-light shadow">
                        <div class="card-body">
                            <h5 class="text-muted fw-normal mt-0">Joined</h5>
                            <h3 class="mt-3 mb-3 text-center"  id="createdAtContainer">---</h3>
                        </div> <!-- end card-body-->
                    </div> <!-- end card-->
                </div> <!-- end col-->
                <div class="col mb-3">
                    <div class="card border-light shadow">
                        <div class="card-body">
                            <h5 class="text-muted fw-normal mt-0">Region</h5>
                            <h3 class="mt-3 mb-3 text-center"  id="regionContainer">---</h3>
                        </div> <!-- end card-body-->
                    </div> <!-- end card-->
                </div> <!-- end col-->
            </div> <!-- end row -->

                <div class="row">
                    <div class="col-md-12 mb-3">
                        <div class="card border-light shadow">
                            <div class="card-body" id="chart-body">
                                <h5 class="text-muted fw-normal my-2">Commits Per Repo</h5>
                                <!-- Create a div where the graph will take place -->
                                <div id="commits_per_repo_chart"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 mb-3">
                        <div class="card border-light shadow">
                            <div class="card-body" id="chart-body">
                                <h5 class="text-muted fw-normal my-2">Top Languages He used</h5>
                                <!-- Create a div where the graph will take place -->
                                <div id="pie-chart-container"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 mb-3">
                        <div class="card border-light shadow">
                            <div class="card-body" id="chart-body">
                                <h5 class="text-muted fw-normal my-2">Top Repos By Stars </h5>
                                <!-- Create a div where the graph will take place -->
                                <div id="stars-chart-container"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 mb-3">
                        <div class="card border-light shadow">
                            <div class="card-body" id="chart-body">
                                <h5 class="text-muted fw-normal my-2">Topics Cloud </h5>
                                <!-- Create a div where the graph will take place -->
                                <div id="topics-container"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>


    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/d3.min.js"></script>
    <!-- Load d3-cloud -->
    <script src="https://cdn.jsdelivr.net/gh/holtzy/D3-graph-gallery@master/LIB/d3.layout.cloud.js"></script>

    <script>

        const inputContainer = document.querySelector('input[type="text"]');
        const dataContainer = document.getElementById("dataContainer");
        const messageContainer = document.getElementById("messageContainer");
        const detailContainer = document.getElementById("detailContainer");
        const commitsContainer = document.getElementById("commits_per_repo_chart");
        const chartBody = document.getElementById("chart-body");
        const pieChartContainer = document.getElementById("pie-chart-container");
        const starsChartContainer = document.getElementById("stars-chart-container");
        const topicsContainer = document.getElementById("topics-container");

        var  chartWitdth = chartBody.clientWidth;

        detailContainer.hidden = true;
        let userListData;

        // POST method
        async function postToServer(url = '', data = {}) {
            // Default options are marked with *
            const response = await fetch(url, {
                method: 'POST', // *GET, POST, PUT, DELETE, etc.
                headers: {
                    'Content-Type': 'application/json'
                },
                body: data // body data type must match "Content-Type" header
            });
            return response.json(); // parses JSON response into native JavaScript objects
        }

        function convertFormDataToJSON(formData){
            const object = {};
            formData.forEach(function(value, key){
                object[key] = value;
            });
            const json = JSON.stringify(object);
            return json;
        }

        function alertContent(response){
            return "<div class=\"alert alert-" + response.type +" alert-dismissible fade show\" role=\"alert\">\n" +
            "<span id=\"messageBody\">" + response.msg + "</span>\n" +
            "<button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\" aria-label=\"Close\"></button>\n" +
            "</div>"
        }

        inputContainer.addEventListener('focus', (event) => {
            event.preventDefault();
            messageContainer.innerHTML = "";
            dataContainer.innerHTML = "";
        })

        inputContainer.addEventListener('blur', (event) => {
            event.preventDefault();
            if (event.currentTarget.value !== ""){
                // loding icon gif
                messageContainer.innerHTML = "<div class=\"text-center\">" +
                    "<div class=\"spinner-border spinner-border-sm\" role=\"status\">" +
                    "<\/div><\/div>";

                const formData = new FormData(document.querySelector('form'));
                const jsonData = convertFormDataToJSON(formData);
                postToServer('/api/user', jsonData)
                    .then(response => {
                        console.log(response);
                        var listItems;
                        if (response.status === 0) {
                            messageContainer.innerHTML = alertContent(response);
                        } else {
                            messageContainer.innerHTML = "";
                            dataContainer.innerHTML = "";
                            userListData = response.data;
                            response.data.forEach(function (d) {
                                dataContainer.innerHTML += "<a href=\"#\" class=\"list-group-item list-group-item-action d-flex gap-3 py-3\" aria-current=\"true\">" +
                                    "<img src=\"" + d.avatar_url + "\" alt=\"twbs\" width=\"32\" height=\"32\" class=\"rounded-circle flex-shrink-0\">" +
                                    "<div class=\"d-flex gap-2 w-100 justify-content-between\">" +
                                    "<div>" +
                                    "<h6 class=\"mb-0\">" + d.name + "</h6> " +
                                    "<div>" +
                                    "<span class=\"badge rounded-pill bg-light text-dark\">followers: " + d.followers + "<\/span>" +
                                    "<span class=\"badge rounded-pill bg-light text-dark\">repos: " + d.public_repos_count + "<\/span>" +
                                    "<span class=\"badge rounded-pill bg-light text-dark\">location: " + d.location ?? "unknown" + "<\/span>" +
                                    "<\/div>" +
                                    "<\/div>" +
                                    "<small class=\"opacity-50 text-nowrap\">now<\/small>" +
                                    "<\/div>" +
                                    "<\/a>";
                            });

                            listItems = document.getElementsByClassName("list-group-item");
                            addClickEnventToListItems(listItems);

                        }});
            }});


        function addClickEnventToListItems(listItems){
            for (let i = 0; i < listItems.length; i++) {

                listItems[i].addEventListener("click", (event) => {

                        for (let i = 0; i < listItems.length; i++) {
                            if (listItems[i].classList.contains("active")) {
                              listItems[i].classList.remove("active")
                        }}

                        activeItem = i;
                        listItems[i].classList.add("active");
                        setUserProfile(i);
                        fetchUserStats(userListData[i].name)
                        detailContainer.hidden = false;
                });
            }

        }

        function fetchUserStats(username) {
            var formData = new FormData(); // å½åä¸ºç©º
            formData.append('name', username);
            const jsonData = convertFormDataToJSON(formData);

            // loding icon gif
            commitsContainer.innerHTML = "<div class=\"text-center\">" +
                "<div class=\"spinner-border spinner-border-sm\" role=\"status\">" +
                "<\/div><\/div>";

            pieChartContainer.innerHTML = "<div class=\"text-center\">" +
                "<div class=\"spinner-border spinner-border-sm\" role=\"status\">" +
                "<\/div><\/div>";

            starsChartContainer.innerHTML = "<div class=\"text-center\">" +
                "<div class=\"spinner-border spinner-border-sm\" role=\"status\">" +
                "<\/div><\/div>";


            topicsContainer.innerHTML = "<div class=\"text-center\">" +
                "<div class=\"spinner-border spinner-border-sm\" role=\"status\">" +
                "<\/div><\/div>";

            postToServer('/api/user/stats', jsonData)
                    .then(response => {
                        console.log(response);
                        generateChart(response.commits);
                        generatePieChart(response.languages);
                        generateStarChart(response.stars);
                        generateTopicsChart(response.topics)
                    });
        }

        function setUserProfile(index){
            var usernameContainer = document.getElementById("usernameContainer");
            var reposCountContainer = document.getElementById("reposCountContainer");
            var followersCountContainer = document.getElementById("followersCountContainer");
            var createdAtContainer = document.getElementById("createdAtContainer");
            var regionContainer = document.getElementById("regionContainer");
            usernameContainer.innerText = userListData[index].name;
            reposCountContainer.innerText = userListData[index].public_repos_count;
            followersCountContainer.innerText  = userListData[index].followers;
            createdAtContainer.innerText  = (new Date(userListData[index].created_at)).toLocaleDateString('en-US');
            regionContainer.innerText  = userListData[index].location ? userListData[index].location:"---";

        }

        function generateChart(data) {
            commitsContainer.innerHTML = "";
            var w = chartWitdth -30;
			var h = 250;


			var dataset = data;

			//create ordinal scale
			var xScale = d3.scaleBand()
							.domain(d3.range(dataset.length))
							.rangeRound([0,w])
							.paddingInner(0.05);

			var yScale = d3.scaleLinear()
							.domain([0, d3.max(dataset)])
							.range([0, h]);


			//Create SVG element
			var svg = d3.select("#commits_per_repo_chart")
						.append("svg")
						.attr("width", w)
						.attr("height", h);

			//build bars
			svg.selectAll("rect")
				.data(dataset)
				.enter()
				.append("rect")
				.attr("x", function(d,i){
					return xScale(i);
				})
				.attr("y", function(d){
					return h - yScale(d);
				})
				.attr("width", xScale.bandwidth())
				.attr("height", function(d) {
					return yScale(d);
				})
				.attr("fill" ,"teal");

			//text labels on bars
			svg.selectAll("text")
				.data(dataset)
				.enter()
				.append("text")
				.text(function(d) {
					return d;
				})
				.attr("x", function(d,i){
					return xScale(i) + xScale.bandwidth() / 2;
				})
				.attr("y", function(d){
					return h - yScale(d) + 14 ;
				})
				.attr("font-family" , "sans-serif")
				.attr("font-size" , "11px")
				.attr("fill" , "black")
				.attr("text-anchor", "middle");
        }

        function generatePieChart(data){
            pieChartContainer.innerHTML = "";

            // set the dimensions and margins of the graph
            const width = chartWitdth -30,
                height = 450,
                margin = 40;

            // The radius of the pieplot is half the width or half the height (smallest one). I subtract a bit of margin.
            const radius = Math.min(width, height) / 2 - margin

            // append the svg object to the div called 'my_dataviz'
            const svg = d3.select("#pie-chart-container")
              .append("svg")
                .attr("width", width)
                .attr("height", height)
              .append("g")
                .attr("transform", `translate(${width / 2}, ${height / 2})`);

            // set the color scale
            const color = d3.scaleOrdinal()
              .range(d3.schemeSet2);

            // Compute the position of each group on the pie:
            const pie = d3.pie()
              .value(function(d) {return d[1]})
            const data_ready = pie(Object.entries(data))
            // Now I know that group A goes from 0 degrees to x degrees and so on.

            // shape helper to build arcs:
            const arcGenerator = d3.arc()
              .innerRadius(0)
              .outerRadius(radius)

            // Build the pie chart: Basically, each part of the pie is a path that we build using the arc function.
            svg
              .selectAll('mySlices')
              .data(data_ready)
              .join('path')
                .attr('d', arcGenerator)
                .attr('fill', function(d){ return(color(d.data[0])) })
                .attr("stroke", "black")
                .style("stroke-width", "2px")
                .style("opacity", 0.7)

            // Now add the annotation. Use the centroid method to get the best coordinates
            svg
              .selectAll('mySlices')
              .data(data_ready)
              .join('text')
              .text(function(d){ return d.data[0]})
              .attr("transform", function(d) { return `translate(${arcGenerator.centroid(d)})`})
              .style("text-anchor", "middle")
              .style("font-size", 17)
        }


        function generateStarChart(data){
                starsChartContainer.innerHTML = "";

                //sort bars based on value
                data = data.sort(function (a, b) {
                    return d3.descending(a.value, b.value);
                })
                console.log(data);

                // set the dimensions and margins of the graph
                const margin = {top: 20, right: 30, bottom: 40, left: 90},
                    width = chartWitdth - margin.left - margin.right,
                    height = 400 - margin.top - margin.bottom;

                // append the svg object to the body of the page
                const svg = d3.select("#stars-chart-container")
                  .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                  .append("g")
                    .attr("transform", `translate(${margin.left}, ${margin.top})`);

                  // Add X axis
                  const x = d3.scaleLinear()
                    .domain([0, data[0].value])
                    .range([ 0, width]);

                  svg.append("g")
                    .attr("transform", `translate(0, ${height})`)
                    .call(d3.axisBottom(x))
                    .selectAll("text")
                      .attr("transform", "translate(-10,0)rotate(-45)")
                      .style("text-anchor", "end");

                  // Y axis
                  const y = d3.scaleBand()
                    .range([ 0, height ])
                    .domain(data.map(d => d.name))
                    .padding(.1);
                  svg.append("g")
                    .call(d3.axisLeft(y))

                  //Bars
                  svg.selectAll("myRect")
                    .data(data)
                    .join("rect")
                    .attr("x", x(0) )
                    .attr("y", d => y(d.name))
                    .attr("width", d => x(d.value))
                    .attr("height", y.bandwidth())
                    .attr("fill", "#69b3a2")

        }

        function generateTopicsChart(data) {
            topicsContainer.innerHTML = "";

                // List of words
                console.log(data)
                // set the dimensions and margins of the graph
                var margin = {top: 10, right: 10, bottom: 10, left: 10},
                    width = chartWitdth - margin.left - margin.right,
                    height = 450 - margin.top - margin.bottom;

                // append the svg object to the body of the page
                var svg = d3.select("#topics-container").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                  .append("g")
                    .attr("transform",
                          "translate(" + margin.left + "," + margin.top + ")");

                // Constructs a new cloud layout instance. It run an algorithm to find the position of words that suits your requirements
                // Wordcloud features that are different from one word to the other must be here
                var layout = d3.layout.cloud()
                  .size([width, height])
                  .words(data.map(function(d) { return {text: d.word, size:d.size}; }))
                  .padding(5)        //space between words
                  .rotate(function() { return ~~(Math.random() * 2) * 90; })
                  .fontSize(function(d) { return d.size%10+30; })      // font size of words
                  .on("end", draw);
                layout.start();


                                      // This function takes the output of 'layout' above and draw the words
                // Wordcloud features that are THE SAME from one word to the other can be here
                function draw(words) {
                  svg
                    .append("g")
                      .attr("transform", "translate(" + layout.size()[0] / 2 + "," + layout.size()[1] / 2 + ")")
                      .selectAll("text")
                        .data(words)
                      .enter().append("text")
                        .style("font-size", function(d) { return d.size%10+30; })
                        .style("fill", "#69b3a2")
                        .attr("text-anchor", "middle")
                        .style("font-family", "Impact")
                        .attr("transform", function(d) {
                          return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                        })
                        .text(function(d) { return d.text; });
                }
        }


</script>
  </body>
</html>
